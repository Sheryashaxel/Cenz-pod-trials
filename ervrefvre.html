<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cenz - Advanced Proof of Delivery System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/4.1.5/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #009933;
            --secondary-color: #f8f9fa;
            --accent-color: #0066cc;
            --text-color: #333;
            --light-gray: #e9ecef;
            --danger: #dc3545;
            --warning: #ffc107;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: var(--secondary-color);
            color: var(--text-color);
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: white;
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            color: var(--primary-color);
            font-size: 28px;
            font-weight: bold;
            text-align: center;
        }

        .section {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }

        h2 {
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 1px solid var(--light-gray);
            padding-bottom: 10px;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 153, 51, 0.2);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            background-color: #007722;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        .secondary-btn {
            background-color: var(--accent-color);
        }

        .secondary-btn:hover {
            background-color: #0055aa;
        }

        .cancel-btn {
            background-color: var(--danger);
        }

        .cancel-btn:hover {
            background-color: #bb2d3b;
        }

        .warning-btn {
            background-color: var(--warning);
            color: #212529;
        }

        .warning-btn:hover {
            background-color: #e0a800;
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .buttons button {
            flex: 1;
            min-width: 120px;
        }

        .signature-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .signature-box {
            border: 1px solid #ddd;
            border-radius: 6px;
            width: 100%;
            height: 200px;
            background-color: white;
            position: relative;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
        }

        .signature-label {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 14px;
            color: #666;
            pointer-events: none;
        }

        .rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .rating > input {
            display: none;
        }

        .rating > label {
            position: relative;
            width: 1.1em;
            font-size: 40px;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s;
        }

        .rating > label::before {
            content: "â˜…";
            position: absolute;
            opacity: 0;
        }

        .rating > label:hover:before,
        .rating > label:hover ~ label:before {
            opacity: 1 !important;
        }

        .rating > input:checked ~ label:before {
            opacity: 1;
        }

        .rating > input:checked ~ label {
            color: #ffc700;
        }

        .media-container {
            width: 100%;
            position: relative;
            overflow: hidden;
            background-color: #000;
            border-radius: 6px;
            aspect-ratio: 4/3;
        }

        #camera-video, #scanner-video, #qr-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .captured-media {
            width: 100%;
            height: auto;
            display: none;
            border-radius: 6px;
            aspect-ratio: 4/3;
            object-fit: contain;
            background-color: #f0f0f0;
        }

        .media-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .upload-option {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }

        .file-upload {
            display: flex;
            flex-direction: column;
        }

        .file-upload-btn {
            margin-top: 10px;
        }

        .preview-container {
            margin-top: 15px;
            max-width: 100%;
            display: none;
        }

        .preview-image {
            max-width: 100%;
            border-radius: 6px;
            aspect-ratio: 4/3;
            object-fit: contain;
            background-color: #f0f0f0;
        }

        .hidden {
            display: none;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 15px;
            gap: 5px;
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            background-color: var(--light-gray);
            border: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            gap: 5px;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 12px;
            background-color: var(--light-gray);
            border-radius: 6px;
            font-weight: 600;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .step:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: transparent;
            transition: background-color 0.3s;
        }

        .active-step {
            background-color: var(--primary-color);
            color: white;
        }

        .active-step:after {
            background-color: white;
        }

        .completed-step {
            background-color: #6c757d;
            color: white;
        }

        .completed-step:after {
            background-color: var(--primary-color);
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .image-card {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            aspect-ratio: 4/3;
            background-color: #f0f0f0;
        }

        .image-card img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .image-card .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: var(--danger);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            padding: 0;
            margin: 0;
        }

        .add-image-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed #ccc;
            cursor: pointer;
            transition: all 0.3s;
        }

        .add-image-btn:hover {
            border-color: var(--primary-color);
            background-color: rgba(0, 153, 51, 0.05);
        }

        .add-image-btn i {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }

        .scanner-line {
            width: 80%;
            height: 2px;
            background-color: rgba(255, 0, 0, 0.7);
            position: relative;
            animation: scan 2s infinite linear;
        }

        @keyframes scan {
            0% { top: 0; }
            50% { top: 100%; }
            100% { top: 0; }
        }

        .scanner-result {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 6px;
            z-index: 2;
        }

        .location-info {
            background-color: var(--light-gray);
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .location-info p {
            margin-bottom: 8px;
            font-size: 14px;
        }

        .location-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background-color: var(--warning);
            color: #212529;
        }

        .status-success {
            background-color: var(--primary-color);
            color: white;
        }

        .status-error {
            background-color: var(--danger);
            color: white;
        }

        .login-container {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .login-title {
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-color);
        }

        .login-btn {
            width: 100%;
            margin-top: 20px;
        }

        .logout-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: var(--danger);
            padding: 8px 15px;
            font-size: 14px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 90%;
            text-align: center;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.success {
            background-color: var(--primary-color);
        }

        .toast.error {
            background-color: var(--danger);
        }

        .toast.warning {
            background-color: var(--warning);
            color: #212529;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .step-indicator {
                flex-direction: column;
                gap: 5px;
            }
            
            .step {
                padding: 8px;
                font-size: 14px;
            }
            
            .image-grid {
                grid-template-columns: 1fr;
            }
            
            .signature-box {
                height: 150px;
            }
            
            .rating > label {
                font-size: 32px;
            }
        }

        @media (max-width: 480px) {
            .login-container {
                margin: 20px auto;
                padding: 20px;
            }
            
            .tab-buttons {
                flex-direction: column;
            }
            
            .tab-button {
                border-radius: 6px;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <h1 class="login-title">Cenz Delivery Agent</h1>
        <div class="form-group">
            <label for="agent-id">Agent ID</label>
            <input type="text" id="agent-id" placeholder="Enter your agent ID" required>
        </div>
        <div class="form-group">
            <label for="agent-pin">PIN</label>
            <input type="password" id="agent-pin" placeholder="Enter your PIN" required>
        </div>
        <button id="login-btn" class="login-btn">
            <span id="login-btn-text">Login</span>
            <span id="login-spinner" class="loading-spinner hidden"></span>
        </button>
    </div>

    <!-- Main App (hidden until login) -->
    <div id="app-container" class="hidden">
        <header>
            <div class="logo">Cenz Delivery</div>
            <button class="logout-btn" id="logout-btn">Logout</button>
        </header>

        <div class="container">
            <div class="step-indicator">
                <div class="step active-step" id="step1-indicator">Customer Details</div>
                <div class="step" id="step2-indicator">Barcode Scan</div>
                <div class="step" id="step3-indicator">Signatures</div>
                <div class="step" id="step4-indicator">Product Images</div>
                <div class="step" id="step5-indicator">Delivery Rating</div>
            </div>

            <!-- Step 1: Customer Details -->
            <div id="step1" class="section">
                <h2>Customer Details</h2>
                <div class="form-group">
                    <label for="customer-name">Customer Name</label>
                    <input type="text" id="customer-name" placeholder="Enter customer name" required>
                </div>
                <div class="form-group">
                    <label for="delivery-address">Delivery Address</label>
                    <input type="text" id="delivery-address" placeholder="Enter delivery address" required>
                </div>
                <div class="form-group">
                    <label for="package-id">Package ID</label>
                    <input type="text" id="package-id" placeholder="Enter package ID" required>
                </div>
                <div class="form-group">
                    <label for="product-name">Product Name</label>
                    <input type="text" id="product-name" placeholder="Enter product name" required>
                </div>
                <div class="form-group">
                    <label for="delivery-notes">Delivery Notes (Optional)</label>
                    <textarea id="delivery-notes" placeholder="Any special delivery instructions"></textarea>
                </div>
                <div class="buttons">
                    <button id="next-to-scan" class="secondary-btn">Next: Scan Barcode</button>
                </div>
            </div>

            <!-- Step 2: Barcode Scan -->
            <div id="step2" class="section hidden">
                <h2>Package Scanning</h2>
                <div class="form-group">
                    <label>Scan Package Code</label>
                    <div class="tab-buttons">
                        <button class="tab-button active" id="barcode-tab-btn">Barcode</button>
                        <button class="tab-button" id="qr-tab-btn">QR Code</button>
                    </div>
                    
                    <div id="barcode-tab" class="tab-content active">
                        <div class="media-container">
                            <video id="scanner-video" playsinline></video>
                            <div class="scanner-overlay">
                                <div class="scanner-line"></div>
                            </div>
                            <div id="scanner-result" class="scanner-result hidden"></div>
                        </div>
                    </div>
                    
                    <div id="qr-tab" class="tab-content hidden">
                        <div class="media-container">
                            <video id="qr-video" playsinline></video>
                            <div class="scanner-overlay">
                                <div class="scanner-line"></div>
                            </div>
                            <div id="qr-result" class="scanner-result hidden"></div>
                        </div>
                    </div>
                    
                    <div class="media-buttons">
                        <button id="start-scan" class="secondary-btn">Start Scanner</button>
                        <button id="stop-scan" class="cancel-btn hidden">Stop Scanner</button>
                        <button id="manual-barcode" class="warning-btn">Enter Manually</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="scanned-barcode">Scanned Code</label>
                    <input type="text" id="scanned-barcode" placeholder="Code will appear here after scan" readonly>
                </div>
                <div class="buttons">
                    <button id="back-to-details">Back</button>
                    <button id="next-to-signature" class="secondary-btn">Next: Signatures</button>
                </div>
            </div>

            <!-- Step 3: Signatures -->
            <div id="step3" class="section hidden">
                <h2>Signatures</h2>
                <div class="form-group">
                    <label>Customer Signature</label>
                    <div class="signature-box">
                        <div class="signature-label">Sign here</div>
                        <canvas id="customer-signature"></canvas>
                    </div>
                </div>
                <div class="form-group">
                    <label>Delivery Agent Signature</label>
                    <div class="signature-box">
                        <div class="signature-label">Sign here</div>
                        <canvas id="agent-signature"></canvas>
                    </div>
                </div>
                <div class="buttons">
                    <button id="clear-customer-sig" class="cancel-btn">Clear Customer</button>
                    <button id="clear-agent-sig" class="cancel-btn">Clear Agent</button>
                    <button id="back-to-scan">Back</button>
                    <button id="next-to-photo" class="secondary-btn">Next: Product Images</button>
                </div>
            </div>

            <!-- Step 4: Product Images -->
            <div id="step4" class="section hidden">
                <h2>Product Images</h2>
                <p>Capture at least one image of the delivered product. Additional images are optional.</p>
                
                <div class="tab-buttons">
                    <button class="tab-button active" id="camera-tab-btn">Take Photos</button>
                    <button class="tab-button" id="upload-tab-btn">Upload Images</button>
                </div>
                
                <!-- Camera Tab -->
                <div id="camera-tab" class="tab-content active">
                    <div class="form-group">
                        <label>Take photos of the delivered product</label>
                        <div class="media-container">
                            <video id="camera-video" autoplay playsinline></video>
                            <img id="captured-image" class="captured-media" alt="Captured product image">
                        </div>
                        <div class="media-buttons">
                            <button id="take-photo">Take Photo</button>
                            <button id="retake-photo" class="hidden">Retake</button>
                            <button id="add-captured-photo" class="hidden secondary-btn">Add to Delivery</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Captured Images</label>
                        <div class="image-grid" id="captured-images-grid">
                            <div class="image-card add-image-btn" id="add-capture-btn">
                                <i>+</i>
                                <span>Add Image</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Upload Tab -->
                <div id="upload-tab" class="tab-content">
                    <div class="form-group">
                        <label for="image-upload">Upload product images</label>
                        <div class="file-upload">
                            <input type="file" id="image-upload" accept="image/*" multiple>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Uploaded Images</label>
                        <div class="image-grid" id="uploaded-images-grid">
                            <div class="image-card add-image-btn" id="add-upload-btn">
                                <i>+</i>
                                <span>Add Image</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Capture -->
                <div class="form-group">
                    <label>Delivery Location</label>
                    <div class="location-info">
                        <p>Latitude: <span id="latitude">Not captured</span></p>
                        <p>Longitude: <span id="longitude">Not captured</span></p>
                        <p>Accuracy: <span id="accuracy">Not available</span> meters</p>
                        <p>Status: <span id="location-status" class="location-status status-pending">Waiting for location</span></p>
                        <p>Last Updated: <span id="location-timestamp">Never</span></p>
                    </div>
                    <div class="buttons">
                        <button id="capture-location" class="secondary-btn">Capture Current Location</button>
                        <button id="refresh-location" class="warning-btn">Refresh Location</button>
                    </div>
                </div>
                
                <div class="buttons">
                    <button id="back-to-signature">Back</button>
                    <button id="next-to-rating" class="secondary-btn">Next: Rate Delivery</button>
                </div>
            </div>

            <!-- Step 5: Delivery Rating -->
            <div id="step5" class="section hidden">
                <h2>Delivery Rating</h2>
                <div class="form-group">
                    <label>How would you rate this delivery?</label>
                    <div class="rating">
                        <input type="radio" id="star5" name="rating" value="5" />
                        <label for="star5" title="5 stars">â˜†</label>
                        <input type="radio" id="star4" name="rating" value="4" />
                        <label for="star4" title="4 stars">â˜†</label>
                        <input type="radio" id="star3" name="rating" value="3" />
                        <label for="star3" title="3 stars">â˜†</label>
                        <input type="radio" id="star2" name="rating" value="2" />
                        <label for="star2" title="2 stars">â˜†</label>
                        <input type="radio" id="star1" name="rating" value="1" />
                        <label for="star1" title="1 star">â˜†</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="delivery-comments">Additional Comments (Optional)</label>
                    <textarea id="delivery-comments" placeholder="Any additional comments about the delivery"></textarea>
                </div>
                <div class="buttons">
                    <button id="back-to-photo">Back</button>
                    <button id="generate-receipt">Complete & Generate Receipt</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        const { jsPDF } = window.jspdf;
        let currentStep = 1;
        let agentSession = null;
        let customerSignaturePad = null;
        let agentSignaturePad = null;
        let cameraStream = null;
        let scannerStream = null;
        let barcodeScannerActive = false;
        let qrScannerActive = false;
        let currentScanMode = 'barcode';
        let locationWatchId = null;
        let currentLocation = null;
        let capturedImages = [];
        let uploadedImages = [];

        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const loginBtnText = document.getElementById('login-btn-text');
        const loginSpinner = document.getElementById('login-spinner');
        const logoutBtn = document.getElementById('logout-btn');

        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const step5 = document.getElementById('step5');

        const step1Indicator = document.getElementById('step1-indicator');
        const step2Indicator = document.getElementById('step2-indicator');
        const step3Indicator = document.getElementById('step3-indicator');
        const step4Indicator = document.getElementById('step4-indicator');
        const step5Indicator = document.getElementById('step5-indicator');

        const barcodeTabBtn = document.getElementById('barcode-tab-btn');
        const qrTabBtn = document.getElementById('qr-tab-btn');
        const barcodeTab = document.getElementById('barcode-tab');
        const qrTab = document.getElementById('qr-tab');
        const startScanBtn = document.getElementById('start-scan');
        const stopScanBtn = document.getElementById('stop-scan');
        const manualBarcodeBtn = document.getElementById('manual-barcode');
        const scannerVideo = document.getElementById('scanner-video');
        const qrVideo = document.getElementById('qr-video');
        const scannerResult = document.getElementById('scanner-result');
        const qrResult = document.getElementById('qr-result');
        const scannedBarcodeInput = document.getElementById('scanned-barcode');

        const customerSignatureCanvas = document.getElementById('customer-signature');
        const agentSignatureCanvas = document.getElementById('agent-signature');
        const clearCustomerSigBtn = document.getElementById('clear-customer-sig');
        const clearAgentSigBtn = document.getElementById('clear-agent-sig');

        const cameraTabBtn = document.getElementById('camera-tab-btn');
        const uploadTabBtn = document.getElementById('upload-tab-btn');
        const cameraTab = document.getElementById('camera-tab');
        const uploadTab = document.getElementById('upload-tab');
        const cameraVideo = document.getElementById('camera-video');
        const capturedImage = document.getElementById('captured-image');
        const takePhotoBtn = document.getElementById('take-photo');
        const retakePhotoBtn = document.getElementById('retake-photo');
        const addCapturedPhotoBtn = document.getElementById('add-captured-photo');
        const capturedImagesGrid = document.getElementById('captured-images-grid');
        const addCaptureBtn = document.getElementById('add-capture-btn');

        const imageUpload = document.getElementById('image-upload');
        const uploadedImagesGrid = document.getElementById('uploaded-images-grid');
        const addUploadBtn = document.getElementById('add-upload-btn');

        const captureLocationBtn = document.getElementById('capture-location');
        const refreshLocationBtn = document.getElementById('refresh-location');
        const latitudeSpan = document.getElementById('latitude');
        const longitudeSpan = document.getElementById('longitude');
        const accuracySpan = document.getElementById('accuracy');
        const locationStatusSpan = document.getElementById('location-status');
        const locationTimestampSpan = document.getElementById('location-timestamp');

        const generateReceiptBtn = document.getElementById('generate-receipt');
        const toast = document.getElementById('toast');

        const nextToScanBtn = document.getElementById('next-to-scan');
        const backToDetailsBtn = document.getElementById('back-to-details');
        const nextToSignatureBtn = document.getElementById('next-to-signature');
        const backToScanBtn = document.getElementById('back-to-scan');
        const nextToPhotoBtn = document.getElementById('next-to-photo');
        const backToSignatureBtn = document.getElementById('back-to-signature');
        const nextToRatingBtn = document.getElementById('next-to-rating');
        const backToPhotoBtn = document.getElementById('back-to-photo');

        function initApp() {
            setupEventListeners();
            checkGeolocationSupport();
        }

        function setupEventListeners() {
            loginBtn.addEventListener('click', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);

            nextToScanBtn.addEventListener('click', () => navigateToStep(2));
            backToDetailsBtn.addEventListener('click', () => navigateToStep(1));
            nextToSignatureBtn.addEventListener('click', () => navigateToStep(3));
            backToScanBtn.addEventListener('click', () => navigateToStep(2));
            nextToPhotoBtn.addEventListener('click', () => navigateToStep(4));
            backToSignatureBtn.addEventListener('click', () => navigateToStep(3));
            nextToRatingBtn.addEventListener('click', () => navigateToStep(5));
            backToPhotoBtn.addEventListener('click', () => navigateToStep(4));

            barcodeTabBtn.addEventListener('click', () => switchScanMode('barcode'));
            qrTabBtn.addEventListener('click', () => switchScanMode('qr'));
            startScanBtn.addEventListener('click', startBarcodeScanner);
            stopScanBtn.addEventListener('click', stopBarcodeScanner);
            manualBarcodeBtn.addEventListener('click', promptManualBarcode);

            clearCustomerSigBtn.addEventListener('click', () => clearSignature('customer'));
            clearAgentSigBtn.addEventListener('click', () => clearSignature('agent'));

            cameraTabBtn.addEventListener('click', () => switchTab('camera'));
            uploadTabBtn.addEventListener('click', () => switchTab('upload'));
            takePhotoBtn.addEventListener('click', takePhoto);
            retakePhotoBtn.addEventListener('click', retakePhoto);
            addCapturedPhotoBtn.addEventListener('click', addCapturedPhotoToGrid);
            addCaptureBtn.addEventListener('click', () => {
                capturedImage.style.display = 'none';
                cameraVideo.style.display = 'block';
                takePhotoBtn.classList.remove('hidden');
                retakePhotoBtn.classList.add('hidden');
                addCapturedPhotoBtn.classList.add('hidden');
            });

            imageUpload.addEventListener('change', handleImageUpload);
            addUploadBtn.addEventListener('click', () => imageUpload.click());

            captureLocationBtn.addEventListener('click', captureCurrentLocation);
            refreshLocationBtn.addEventListener('click', refreshLocation);

            generateReceiptBtn.addEventListener('click', generateReceipt);

            window.addEventListener('resize', resizeSignatureCanvases);
        }

        function handleLogin() {
            const agentId = document.getElementById('agent-id').value.trim();
            const agentPin = document.getElementById('agent-pin').value.trim();

            if (!agentId || !agentPin) {
                showToast('Please enter both Agent ID and PIN', 'error');
                return;
            }

            loginBtn.disabled = true;
            loginBtnText.textContent = 'Authenticating...';
            loginSpinner.classList.remove('hidden');

            setTimeout(() => {
                if (agentId === 'demo' && agentPin === '1234') {
                    agentSession = { id: agentId, name: 'Demo Agent', timestamp: new Date() };
                    loginScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    showToast('Login successful', 'success');
                    startLocationTracking();
                } else {
                    showToast('Invalid Agent ID or PIN', 'error');
                }

                loginBtn.disabled = false;
                loginBtnText.textContent = 'Login';
                loginSpinner.classList.add('hidden');
            }, 1500);
        }

        function handleLogout() {
            stopCamera();
            stopBarcodeScanner();
            stopLocationTracking();
            agentSession = null;
            resetForm();
            appContainer.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            document.getElementById('agent-id').value = '';
            document.getElementById('agent-pin').value = '';
            showToast('Logged out successfully', 'success');
        }

        function navigateToStep(stepNumber) {
            if (!validateCurrentStep(currentStep)) return;

            step1.classList.add('hidden');
            step2.classList.add('hidden');
            step3.classList.add('hidden');
            step4.classList.add('hidden');
            step5.classList.add('hidden');

            step1Indicator.classList.remove('active-step', 'completed-step');
            step2Indicator.classList.remove('active-step', 'completed-step');
            step3Indicator.classList.remove('active-step', 'completed-step');
            step4Indicator.classList.remove('active-step', 'completed-step');
            step5Indicator.classList.remove('active-step', 'completed-step');

            switch(stepNumber) {
                case 1:
                    step1.classList.remove('hidden');
                    step1Indicator.classList.add('active-step');
                    break;
                case 2:
                    step2.classList.remove('hidden');
                    step1Indicator.classList.add('completed-step');
                    step2Indicator.classList.add('active-step');
                    break;
                case 3:
                    step3.classList.remove('hidden');
                    step1Indicator.classList.add('completed-step');
                    step2Indicator.classList.add('completed-step');
                    step3Indicator.classList.add('active-step');
                    initSignaturePads();
                    break;
                case 4:
                    step4.classList.remove('hidden');
                    step1Indicator.classList.add('completed-step');
                    step2Indicator.classList.add('completed-step');
                    step3Indicator.classList.add('completed-step');
                    step4Indicator.classList.add('active-step');
                    if (cameraTab.classList.contains('active')) startCamera();
                    break;
                case 5:
                    step5.classList.remove('hidden');
                    step1Indicator.classList.add('completed-step');
                    step2Indicator.classList.add('completed-step');
                    step3Indicator.classList.add('completed-step');
                    step4Indicator.classList.add('completed-step');
                    step5Indicator.classList.add('active-step');
                    stopCamera();
                    break;
            }

            currentStep = stepNumber;
            window.scrollTo(0, 0);
        }

        function validateCurrentStep(step) {
            switch(step) {
                case 1: return validateStep1();
                case 2: return validateStep2();
                case 3: return validateStep3();
                case 4: return validateStep4();
                default: return true;
            }
        }

        function validateStep1() {
            const customerName = document.getElementById('customer-name').value.trim();
            const deliveryAddress = document.getElementById('delivery-address').value.trim();
            const packageId = document.getElementById('package-id').value.trim();
            const productName = document.getElementById('product-name').value.trim();

            if (!customerName || !deliveryAddress || !packageId || !productName) {
                showToast('Please fill in all required fields', 'error');
                return false;
            }
            return true;
        }

        function validateStep2() {
            const barcode = scannedBarcodeInput.value.trim();
            if (!barcode) {
                showToast('Please scan or enter the package code', 'error');
                return false;
            }
            return true;
        }

        function validateStep3() {
            if (!customerSignaturePad || customerSignaturePad.isEmpty()) {
                showToast('Customer signature is required', 'error');
                return false;
            }
            if (!agentSignaturePad || agentSignaturePad.isEmpty()) {
                showToast('Agent signature is required', 'error');
                return false;
            }
            return true;
        }

        function validateStep4() {
            if (capturedImages.length + uploadedImages.length === 0) {
                showToast('At least one product image is required', 'error');
                return false;
            }
            if (!currentLocation) {
                showToast('Please capture the delivery location', 'error');
                return false;
            }
            return true;
        }

        function initSignaturePads() {
            if (customerSignaturePad) {
                customerSignaturePad.off();
                customerSignaturePad = null;
            }
            if (agentSignaturePad) {
                agentSignaturePad.off();
                agentSignaturePad = null;
            }

            const pixelRatio = window.devicePixelRatio || 1;

            customerSignatureCanvas.width = customerSignatureCanvas.offsetWidth * pixelRatio;
            customerSignatureCanvas.height = customerSignatureCanvas.offsetHeight * pixelRatio;
            customerSignatureCanvas.getContext('2d').scale(pixelRatio, pixelRatio);

            agentSignatureCanvas.width = agentSignatureCanvas.offsetWidth * pixelRatio;
            agentSignatureCanvas.height = agentSignatureCanvas.offsetHeight * pixelRatio;
            agentSignatureCanvas.getContext('2d').scale(pixelRatio, pixelRatio);

            customerSignaturePad = new SignaturePad(customerSignatureCanvas, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)',
                minWidth: 1,
                maxWidth: 2.5
            });

            agentSignaturePad = new SignaturePad(agentSignatureCanvas, {
                backgroundColor: 'rgb(255, 255, 255)',
                penColor: 'rgb(0, 0, 0)',
                minWidth: 1,
                maxWidth: 2.5
            });

            const preventTouch = (e) => e.preventDefault();
            customerSignatureCanvas.addEventListener('touchstart', preventTouch, { passive: false });
            customerSignatureCanvas.addEventListener('touchmove', preventTouch, { passive: false });
            agentSignatureCanvas.addEventListener('touchstart', preventTouch, { passive: false });
            agentSignatureCanvas.addEventListener('touchmove', preventTouch, { passive: false });
        }

        function resizeSignatureCanvases() {
            if (!customerSignaturePad || !agentSignaturePad) return;

            const pixelRatio = window.devicePixelRatio || 1;
            const customerData = customerSignaturePad.toData();
            const agentData = agentSignaturePad.toData();

            customerSignatureCanvas.width = customerSignatureCanvas.offsetWidth * pixelRatio;
            customerSignatureCanvas.height = customerSignatureCanvas.offsetHeight * pixelRatio;
            customerSignatureCanvas.getContext('2d').scale(pixelRatio, pixelRatio);
            customerSignaturePad.fromData(customerData);

            agentSignatureCanvas.width = agentSignatureCanvas.offsetWidth * pixelRatio;
            agentSignatureCanvas.height = agentSignatureCanvas.offsetHeight * pixelRatio;
            agentSignatureCanvas.getContext('2d').scale(pixelRatio, pixelRatio);
            agentSignaturePad.fromData(agentData);
        }

        function clearSignature(type) {
            if (type === 'customer' && customerSignaturePad) {
                customerSignaturePad.clear();
            } else if (type === 'agent' && agentSignaturePad) {
                agentSignaturePad.clear();
            }
        }

        function switchScanMode(mode) {
            stopBarcodeScanner();
            barcodeTabBtn.classList.remove('active');
            qrTabBtn.classList.remove('active');
            barcodeTab.classList.remove('active');
            qrTab.classList.remove('active');

            if (mode === 'barcode') {
                barcodeTabBtn.classList.add('active');
                barcodeTab.classList.add('active');
                currentScanMode = 'barcode';
            } else {
                qrTabBtn.classList.add('active');
                qrTab.classList.add('active');
                currentScanMode = 'qr';
            }
        }

        function startBarcodeScanner() {
            stopBarcodeScanner();

            if (currentScanMode === 'barcode') {
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: scannerVideo,
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment"
                        },
                    },
                    decoder: {
                        readers: [
                            "ean_reader",
                            "ean_8_reader",
                            "code_128_reader",
                            "code_39_reader",
                            "codabar_reader",
                            "upc_reader",
                            "upc_e_reader"
                        ]
                    },
                    locate: true
                }, function(err) {
                    if (err) {
                        showToast('Failed to initialize barcode scanner', 'error');
                        return;
                    }
                    Quagga.start();
                    barcodeScannerActive = true;
                    startScanBtn.classList.add('hidden');
                    stopScanBtn.classList.remove('hidden');

                    Quagga.onDetected(function(result) {
                        const code = result.codeResult.code;
                        scannedBarcodeInput.value = code;
                        scannerResult.textContent = `Scanned: ${code}`;
                        scannerResult.classList.remove('hidden');
                        setTimeout(stopBarcodeScanner, 1000);
                    });
                });
            } else {
                navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment" }
                }).then(stream => {
                    qrVideo.srcObject = stream;
                    scannerStream = stream;
                    qrScannerActive = true;
                    startScanBtn.classList.add('hidden');
                    stopScanBtn.classList.remove('hidden');

                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    function scanQR() {
                        if (!qrScannerActive) return;

                        canvas.width = qrVideo.videoWidth;
                        canvas.height = qrVideo.videoHeight;
                        ctx.drawImage(qrVideo, 0, 0, canvas.width, canvas.height);

                        try {
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height);

                            if (code) {
                                scannedBarcodeInput.value = code.data;
                                qrResult.textContent = `Scanned: ${code.data}`;
                                qrResult.classList.remove('hidden');
                                setTimeout(stopBarcodeScanner, 1000);
                                return;
                            }
                        } catch (e) {
                            console.log('QR scan error:', e);
                        }

                        requestAnimationFrame(scanQR);
                    }

                    scanQR();
                }).catch(err => {
                    showToast('Failed to initialize QR scanner', 'error');
                });
            }
        }

        function stopBarcodeScanner() {
            if (barcodeScannerActive) {
                Quagga.stop();
                barcodeScannerActive = false;
            }
            if (qrScannerActive) {
                if (scannerStream) {
                    scannerStream.getTracks().forEach(track => track.stop());
                }
                qrScannerActive = false;
            }
            startScanBtn.classList.remove('hidden');
            stopScanBtn.classList.add('hidden');
            scannerResult.classList.add('hidden');
            qrResult.classList.add('hidden');
        }

        function promptManualBarcode() {
            const barcode = prompt('Please enter the package code:');
            if (barcode) {
                scannedBarcodeInput.value = barcode;
            }
        }

        async function startCamera() {
            try {
                stopCamera();
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                cameraVideo.srcObject = cameraStream;
                cameraVideo.style.display = 'block';
                capturedImage.style.display = 'none';
                takePhotoBtn.classList.remove('hidden');
                retakePhotoBtn.classList.add('hidden');
                addCapturedPhotoBtn.classList.add('hidden');
            } catch (err) {
                showToast('Unable to access camera. Please use upload option instead.', 'error');
                switchTab('upload');
            }
        }

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
        }

        function takePhoto() {
            const canvas = document.createElement('canvas');
            canvas.width = cameraVideo.videoWidth;
            canvas.height = cameraVideo.videoHeight;
            canvas.getContext('2d').drawImage(cameraVideo, 0, 0);
            capturedImage.src = canvas.toDataURL('image/jpeg', 0.8);
            capturedImage.style.display = 'block';
            cameraVideo.style.display = 'none';
            takePhotoBtn.classList.add('hidden');
            retakePhotoBtn.classList.remove('hidden');
            addCapturedPhotoBtn.classList.remove('hidden');
        }

        function retakePhoto() {
            capturedImage.style.display = 'none';
            cameraVideo.style.display = 'block';
            takePhotoBtn.classList.remove('hidden');
            retakePhotoBtn.classList.add('hidden');
            addCapturedPhotoBtn.classList.add('hidden');
        }

        function addCapturedPhotoToGrid() {
            if (!capturedImage.src) return;
            const timestamp = new Date().toISOString();
            capturedImages.push({
                id: `capture-${Date.now()}`,
                src: capturedImage.src,
                timestamp: timestamp
            });
            updateCapturedImagesGrid();
            retakePhoto();
            showToast('Photo added to delivery', 'success');
        }

        function updateCapturedImagesGrid() {
            capturedImagesGrid.innerHTML = '';
            capturedImages.forEach((image, index) => {
                const imageCard = document.createElement('div');
                imageCard.className = 'image-card';
                const img = document.createElement('img');
                img.src = image.src;
                img.alt = `Product image ${index + 1}`;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = 'Ã—';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    capturedImages = capturedImages.filter(img => img.id !== image.id);
                    updateCapturedImagesGrid();
                });
                imageCard.appendChild(img);
                imageCard.appendChild(removeBtn);
                capturedImagesGrid.appendChild(imageCard);
            });
            capturedImagesGrid.appendChild(addCaptureBtn);
        }

        function handleImageUpload(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const timestamp = new Date().toISOString();
                    uploadedImages.push({
                        id: `upload-${Date.now()}`,
                        src: event.target.result,
                        filename: file.name,
                        timestamp: timestamp
                    });
                    updateUploadedImagesGrid();
                };
                reader.readAsDataURL(file);
            });
            showToast(`${files.length} image(s) uploaded`, 'success');
        }

        function updateUploadedImagesGrid() {
            uploadedImagesGrid.innerHTML = '';
            uploadedImages.forEach((image, index) => {
                const imageCard = document.createElement('div');
                imageCard.className = 'image-card';
                const img = document.createElement('img');
                img.src = image.src;
                img.alt = `Uploaded image ${index + 1}`;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = 'Ã—';
                removeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    uploadedImages = uploadedImages.filter(img => img.id !== image.id);
                    updateUploadedImagesGrid();
                });
                imageCard.appendChild(img);
                imageCard.appendChild(removeBtn);
                uploadedImagesGrid.appendChild(imageCard);
            });
            uploadedImagesGrid.appendChild(addUploadBtn);
        }

        function switchTab(tab) {
            if (tab === 'camera') {
                cameraTabBtn.classList.add('active');
                uploadTabBtn.classList.remove('active');
                cameraTab.classList.add('active');
                uploadTab.classList.remove('active');
                if (!step4.classList.contains('hidden')) startCamera();
            } else {
                uploadTabBtn.classList.add('active');
                cameraTabBtn.classList.remove('active');
                uploadTab.classList.add('active');
                cameraTab.classList.remove('active');
                stopCamera();
            }
        }

        function checkGeolocationSupport() {
            if (!navigator.geolocation) {
                showToast('Geolocation is not supported by your browser', 'error');
                captureLocationBtn.disabled = true;
                refreshLocationBtn.disabled = true;
                locationStatusSpan.textContent = 'Not supported';
                locationStatusSpan.className = 'location-status status-error';
            }
        }

        function startLocationTracking() {
            if (locationWatchId) return;
            showToast('Starting location tracking...', 'warning');
            locationWatchId = navigator.geolocation.watchPosition(
                position => {
                    updateLocationInfo(position);
                    if (!currentLocation) {
                        currentLocation = position;
                        showToast('Initial location acquired', 'success');
                    }
                },
                error => handleLocationError(error),
                { enableHighAccuracy: true, maximumAge: 10000, timeout: 15000 }
            );
        }

        function stopLocationTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
                showToast('Location tracking stopped', 'warning');
            }
        }

        function captureCurrentLocation() {
            captureLocationBtn.disabled = true;
            captureLocationBtn.innerHTML = '<span class="loading-spinner"></span> Locating...';
            showToast('Attempting to capture location...', 'warning');

            const maxAttempts = 3;
            let attempt = 0;

            function tryGetLocation() {
                attempt++;
                navigator.geolocation.getCurrentPosition(
                    position => {
                        updateLocationInfo(position);
                        currentLocation = position;
                        captureLocationBtn.disabled = false;
                        captureLocationBtn.textContent = 'Capture Current Location';
                        showToast('Location captured successfully', 'success');
                    },
                    error => {
                        if (attempt < maxAttempts) {
                            showToast(`Location attempt ${attempt} failed, retrying...`, 'warning');
                            setTimeout(tryGetLocation, 2000);
                        } else {
                            handleLocationError(error);
                            captureLocationBtn.disabled = false;
                            captureLocationBtn.textContent = 'Capture Current Location';
                        }
                    },
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
                );
            }

            tryGetLocation();
        }

        function refreshLocation() {
            refreshLocationBtn.disabled = true;
            refreshLocationBtn.innerHTML = '<span class="loading-spinner"></span> Refreshing...';
            showToast('Refreshing location...', 'warning');

            navigator.geolocation.getCurrentPosition(
                position => {
                    updateLocationInfo(position);
                    currentLocation = position;
                    refreshLocationBtn.disabled = false;
                    refreshLocationBtn.textContent = 'Refresh Location';
                    showToast('Location refreshed successfully', 'success');
                },
                error => {
                    handleLocationError(error);
                    refreshLocationBtn.disabled = false;
                    refreshLocationBtn.textContent = 'Refresh Location';
                },
                { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
            );
        }

        function updateLocationInfo(position) {
            const { latitude, longitude, accuracy } = position.coords;
            const timestamp = new Date(position.timestamp).toLocaleString();
            latitudeSpan.textContent = latitude.toFixed(6);
            longitudeSpan.textContent = longitude.toFixed(6);
            accuracySpan.textContent = Math.round(accuracy);
            locationTimestampSpan.textContent = timestamp;
            locationStatusSpan.textContent = 'Location acquired';
            locationStatusSpan.className = 'location-status status-success';
        }

        function handleLocationError(error) {
            let errorMessage = '';
            switch(error.code) {
                case error.PERMISSION_DENIED: errorMessage = 'Location access denied by user'; break;
                case error.POSITION_UNAVAILABLE: errorMessage = 'Location information unavailable'; break;
                case error.TIMEOUT: errorMessage = 'Location request timed out'; break;
                case error.UNKNOWN_ERROR: errorMessage = 'Unknown error occurred'; break;
            }
            locationStatusSpan.textContent = errorMessage;
            locationStatusSpan.className = 'location-status status-error';
            showToast(errorMessage, 'error');
        }

        async function generateReceipt() {
            let rating = 0;
            const ratingInputs = document.querySelectorAll('input[name="rating"]');
            for (const input of ratingInputs) {
                if (input.checked) {
                    rating = parseInt(input.value);
                    break;
                }
            }
            if (rating === 0) {
                showToast('Please select a rating for the delivery', 'error');
                return;
            }

            const originalBtnText = generateReceiptBtn.innerHTML;
            generateReceiptBtn.disabled = true;
            generateReceiptBtn.innerHTML = '<span class="loading-spinner"></span> Generating...';

            try {
                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                const currentDate = new Date();
                const filename = `Cenz_Delivery_${document.getElementById('package-id').value}_${currentDate.toISOString().slice(0,10)}`;
                let yPos = 20;

                // Header
                doc.setFillColor(0, 153, 51); // Green
                doc.rect(0, 0, 595, 60, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.text("Cenz - Proof of Delivery", 297, 40, { align: 'center' });
                yPos += 80;

                // Metadata
                doc.setTextColor(51, 51, 51);
                doc.setFontSize(10);
                doc.text(`Generated: ${currentDate.toLocaleString()}`, 40, yPos);
                doc.text(`Agent: ${agentSession ? agentSession.id : 'Unknown'}`, 40, yPos + 10);
                yPos += 40;

                // Delivery Details
                doc.setFontSize(12);
                doc.setTextColor(0, 153, 51);
                doc.text("Delivery Details", 40, yPos);
                doc.setLineWidth(0.5);
                doc.line(40, yPos + 5, 180, yPos + 5);
                doc.setTextColor(51, 51, 51);
                doc.setFontSize(10);
                yPos += 15;
                doc.text(`Customer: ${document.getElementById('customer-name').value}`, 40, yPos);
                doc.text(`Address: ${document.getElementById('delivery-address').value}`, 40, yPos + 10);
                doc.text(`Package ID: ${document.getElementById('package-id').value}`, 40, yPos + 20);
                doc.text(`Product: ${document.getElementById('product-name').value}`, 40, yPos + 30);
                doc.text(`Barcode: ${scannedBarcodeInput.value}`, 40, yPos + 40);
                if (document.getElementById('delivery-notes').value) {
                    doc.text(`Notes: ${document.getElementById('delivery-notes').value}`, 40, yPos + 50);
                    yPos += 60;
                } else {
                    yPos += 50;
                }

                // Location
                doc.setFontSize(12);
                doc.setTextColor(0, 153, 51);
                doc.text("Delivery Location", 40, yPos);
                doc.line(40, yPos + 5, 180, yPos + 5);
                doc.setTextColor(51, 51, 51);
                doc.setFontSize(10);
                yPos += 15;
                if (currentLocation) {
                    doc.rect(400, yPos - 10, 150, 50, 'F'); // Placeholder map
                    doc.setFillColor(233, 236, 239);
                    doc.text("Map Placeholder", 475, yPos + 15, { align: 'center' });
                    doc.setFillColor(255, 255, 255);
                    doc.text(`Latitude: ${currentLocation.coords.latitude.toFixed(6)}`, 40, yPos);
                    doc.text(`Longitude: ${currentLocation.coords.longitude.toFixed(6)}`, 40, yPos + 10);
                    doc.text(`Accuracy: ${Math.round(currentLocation.coords.accuracy)} meters`, 40, yPos + 20);
                    doc.text(`Timestamp: ${new Date(currentLocation.timestamp).toLocaleString()}`, 40, yPos + 30);
                    yPos += 50;
                } else {
                    doc.text("Location not captured", 40, yPos);
                    yPos += 20;
                }

                // Signatures
                doc.setFontSize(12);
                doc.setTextColor(0, 153, 51);
                doc.text("Signatures", 40, yPos);
                doc.line(40, yPos + 5, 120, yPos + 5);
                doc.setTextColor(51, 51, 51);
                doc.setFontSize(10);
                yPos += 15;
                if (customerSignaturePad && !customerSignaturePad.isEmpty()) {
                    const customerSigData = customerSignaturePad.toDataURL('image/png');
                    doc.addImage(customerSigData, 'PNG', 40, yPos, 250, 100);
                } else {
                    doc.text("Customer Signature: Not provided", 40, yPos);
                }
                if (agentSignaturePad && !agentSignaturePad.isEmpty()) {
                    const agentSigData = agentSignaturePad.toDataURL('image/png');
                    doc.addImage(agentSigData, 'PNG', 305, yPos, 250, 100);
                } else {
                    doc.text("Agent Signature: Not provided", 305, yPos);
                }
                yPos += 120;

                // Product Images
                doc.setFontSize(12);
                doc.setTextColor(0, 153, 51);
                doc.text("Product Images", 40, yPos);
                doc.line(40, yPos + 5, 150, yPos + 5);
                doc.setTextColor(51, 51, 51);
                doc.setFontSize(10);
                yPos += 15;
                const allImages = capturedImages.concat(uploadedImages);
                if (allImages.length > 0) {
                    for (let i = 0; i < allImages.length; i++) {
                        if (yPos > 700) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.addImage(allImages[i].src, 'JPEG', 40 + (i % 2) * 280, yPos, 250, 150);
                        doc.text(`Image ${i + 1} (${new Date(allImages[i].timestamp).toLocaleTimeString()})`, 
                            40 + (i % 2) * 280, yPos + 160);
                        if (i % 2 === 1) yPos += 180;
                    }
                    if (allImages.length % 2 === 1) yPos += 180;
                } else {
                    doc.text("No product images captured", 40, yPos);
                    yPos += 20;
                }

                // Rating
                doc.setFontSize(12);
                doc.setTextColor(0, 153, 51);
                doc.text("Delivery Rating", 40, yPos);
                doc.line(40, yPos + 5, 140, yPos + 5);
                doc.setTextColor(51, 51, 51);
                doc.setFontSize(10);
                yPos += 15;
                doc.text(`${rating} out of 5 stars`, 40, yPos);
                if (document.getElementById('delivery-comments').value) {
                    doc.text(`Comments: ${document.getElementById('delivery-comments').value}`, 40, yPos + 10);
                    yPos += 20;
                } else {
                    yPos += 10;
                }

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(102, 102, 102);
                doc.text("This document serves as proof of delivery. Thank you for choosing Cenz.", 297, 822, { align: 'center' });

                // Mobile-friendly download
                const pdfOutput = doc.output('blob');
                const url = URL.createObjectURL(pdfOutput);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${filename}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                showToast('Receipt generated successfully', 'success');
                resetForm();
            } catch (error) {
                console.error('PDF Generation Error:', error);
                showToast('Error generating receipt. Check console for details.', 'error');
            } finally {
                generateReceiptBtn.disabled = false;
                generateReceiptBtn.innerHTML = originalBtnText;
            }
        }

        function resetForm() {
            document.getElementById('customer-name').value = '';
            document.getElementById('delivery-address').value = '';
            document.getElementById('package-id').value = '';
            document.getElementById('product-name').value = '';
            document.getElementById('delivery-notes').value = '';
            document.getElementById('delivery-comments').value = '';
            document.getElementById('scanned-barcode').value = '';
            document.getElementById('image-upload').value = '';

            if (customerSignaturePad) customerSignaturePad.clear();
            if (agentSignaturePad) agentSignaturePad.clear();

            const ratingInputs = document.querySelectorAll('input[name="rating"]');
            for (const input of ratingInputs) input.checked = false;

            capturedImages = [];
            uploadedImages = [];
            updateCapturedImagesGrid();
            updateUploadedImagesGrid();

            currentLocation = null;
            latitudeSpan.textContent = 'Not captured';
            longitudeSpan.textContent = 'Not captured';
            accuracySpan.textContent = 'Not available';
            locationStatusSpan.textContent = 'Waiting for location';
            locationStatusSpan.className = 'location-status status-pending';
            locationTimestampSpan.textContent = 'Never';

            navigateToStep(1);
            switchTab('camera');
            stopCamera();
        }

        function showToast(message, type = 'info') {
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => toast.className = 'toast', 3000);
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>